rules_version = '2';

// Firebase Storage Rules for Cleveland Clean Solutions V2
// Simplified rules that allow proper access to photos

service firebase.storage {
  match /b/{bucket}/o {
    // V1 Rules - Allow employees to upload to their own folder
    match /employeeUploads/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow clients to read photos from employeeUploads if they have client token
      allow read: if request.auth != null && 
        (request.auth.token.admin == true || 
         request.auth.token.owner == true ||
         request.auth.token.client == true);
    }
    
    // V1 Rules - Allow clients to read photos that are marked as client-visible
    match /servicePhotos/{photoId} {
      allow read: if request.auth != null && 
        (request.auth.token.admin == true || 
         request.auth.token.owner == true ||
         request.auth.token.client == true);
    }
    
    // V1 Rules - Allow admins and super_admins to upload contract documents
    match /contractUploads/{clientId}/{allPaths=**} {
      allow read, write: if request.auth != null && 
        (request.auth.token.admin == true || 
         request.auth.token.super_admin == true || 
         request.auth.token.owner == true);
    }
    
    // V1 Rules - Allow admins and owners to read all uploads
    match /{allPaths=**} {
      allow read: if request.auth != null && 
        (request.auth.token.admin == true || request.auth.token.owner == true);
    }

    // V2 Media Library Rules - Simplified without Firestore functions
    match /media/{assetId} {
      // Uploads: admins, owner
      allow write: if request.auth != null && (request.auth.token.admin == true || request.auth.token.owner == true || request.auth.token.super_admin == true);
      // Deletes: super_admin only
      allow delete: if request.auth != null && request.auth.token.super_admin == true;
      // Reads: allow authenticated users with proper roles
      allow read: if request.auth != null && 
        (request.auth.token.admin == true || 
         request.auth.token.owner == true || 
         request.auth.token.super_admin == true ||
         request.auth.token.client == true ||
         request.auth.token.employee == true);
    }

    // Allow nested folders under media as well
    match /media/{assetId}/{all=**} {
      allow write: if request.auth != null && (request.auth.token.admin == true || request.auth.token.owner == true || request.auth.token.super_admin == true);
      allow delete: if request.auth != null && request.auth.token.super_admin == true;
      // TEMP: Allow all authenticated users to read for debugging
      allow read: if request.auth != null;
    }
  }
}
